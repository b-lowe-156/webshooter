<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
    <title>Babylon - Getting Started</title>
    <!--- link to the last version of babylon
    <script src="libs/babylon.max.js"></script>
     --->
    <script src="http://www.babylonjs.com/cannon.js"></script>
    <script src="http://www.babylonjs.com/Oimo.js"></script>
    <script src="http://www.babylonjs.com/babylon.js">

    <script src="http://babylonjs-playground.azurewebsites.net/babylon.fireMaterial.min.js"></script>
    <script src="http://babylonjs-playground.azurewebsites.net/babylon.waterMaterial.min.js"></script>
    <script src="http://babylonjs-playground.azurewebsites.net/babylon.lavaMaterial.min.js"></script>
    <script src="http://babylonjs-playground.azurewebsites.net/babylon.normalMaterial.min.js"></script>
    <script src="http://babylonjs-playground.azurewebsites.net/babylon.skyMaterial.min.js"></script>
    <script src="http://babylonjs-playground.azurewebsites.net/babylon.triPlanarMaterial.min.js"></script>
    <script src="http://babylonjs-playground.azurewebsites.net/babylon.terrainMaterial.min.js"></script>
    <script src="http://babylonjs-playground.azurewebsites.net/babylon.gradientMaterial.min.js"></script>
    <script src="http://babylonjs-playground.azurewebsites.net/babylon.furMaterial.min.js"></script>
    <script src="http://babylonjs-playground.azurewebsites.net/babylon.gridMaterial.min.js"></script>

    <script src="http://babylonjs-playground.azurewebsites.net/babylon.brickProceduralTexture.min.js"></script>
    <script src="http://babylonjs-playground.azurewebsites.net/babylon.cloudProceduralTexture.min.js"></script>
    <script src="http://babylonjs-playground.azurewebsites.net/babylon.fireProceduralTexture.min.js"></script>
    <script src="http://babylonjs-playground.azurewebsites.net/babylon.grassProceduralTexture.min.js"></script>
    <script src="http://babylonjs-playground.azurewebsites.net/babylon.marbleProceduralTexture.min.js"></script>
    <script src="http://babylonjs-playground.azurewebsites.net/babylon.roadProceduralTexture.min.js"></script>
    <script src="http://babylonjs-playground.azurewebsites.net/babylon.starfieldProceduralTexture.min.js"></script>
    <script src="http://babylonjs-playground.azurewebsites.net/babylon.woodProceduralTexture.min.js"></script>    

    <script src="http://babylonjs-playground.azurewebsites.net/babylon.objFileLoader.js"></script>
    
    
    <style>
        html, body {
            overflow: hidden;
            width   : 100%;
            height  : 100%;
            margin  : 0;
            padding : 0;
        }

        #renderCanvas {
            width   : 100%;
            height  : 100%;
            touch-action: none;
        }
    </style>
    <script>
    //function updateStats(memuse) {
    //    document.getElementById('rss').innerHTML = memuse.rss;
    //    document.getElementById('heapTotal').innerHTML = memuse.heapTotal;
    //    document.getElementById('heapUsed').innerHTML = memuse.heapUsed;
    //  }

    //  var host = window.document.location.host.replace(/:.*/, '');
    //  var ws = new WebSocket('ws://' + host + ':8080');
    //  ws.onmessage = function (event) {
    //    updateStats(JSON.parse(event.data));
    //  };
    //*/
    </script>
    <script>
        window.addEventListener('DOMContentLoaded', function(){
            // get the canvas DOM element
            var canvas = document.getElementById('renderCanvas');

            // load the 3D engine
            var engine = new BABYLON.Engine(canvas, true);

            // createScene function that creates and return the scene
            var createScene = function(){
              var scene = new BABYLON.Scene(engine);
            
            // Camera
              var camera = new BABYLON.FreeCamera("camera1", new BABYLON.Vector3(5, 4, -47), scene);
              camera.setTarget(BABYLON.Vector3.Zero());
              camera.attachControl(canvas, true);
            
            // Light
            var light = new BABYLON.DirectionalLight("dir01", new BABYLON.Vector3(-1, -2, -1), scene);
            light.position = new BABYLON.Vector3(20, 40, 20);
            light.intensity = 0.8;
            
            // Create terrain material
            var terrainMaterial = new BABYLON.TerrainMaterial("terrainMaterial", scene);
              terrainMaterial.specularColor = new BABYLON.Color3(0.5, 0.5, 0.5);
              terrainMaterial.specularPower = 64;
            
            // Set the mix texture (represents the RGB values)
              terrainMaterial.mixTexture = new BABYLON.Texture("textures/mixMap.png", scene);
            
            // Diffuse textures following the RGB values of the mix map
            // diffuseTexture1: Red
            // diffuseTexture2: Green
            // diffuseTexture3: Blue
              terrainMaterial.diffuseTexture1 = new BABYLON.Texture("textures/floor.png", scene);
              terrainMaterial.diffuseTexture2 = new BABYLON.Texture("textures/rock.png", scene);
              terrainMaterial.diffuseTexture3 = new BABYLON.Texture("textures/grass.png", scene);
              
            // Bump textures according to the previously set diffuse textures
              terrainMaterial.bumpTexture1 = new BABYLON.Texture("textures/floor_bump.png", scene);
              terrainMaterial.bumpTexture2 = new BABYLON.Texture("textures/rockn.png", scene);
              terrainMaterial.bumpTexture3 = new BABYLON.Texture("textures/grassn.png", scene);
            
              // Rescale textures according to the terrain
              terrainMaterial.diffuseTexture1.uScale = terrainMaterial.diffuseTexture1.vScale = 10;
              terrainMaterial.diffuseTexture2.uScale = terrainMaterial.diffuseTexture2.vScale = 10;
              terrainMaterial.diffuseTexture3.uScale = terrainMaterial.diffuseTexture3.vScale = 10;

	            var box = BABYLON.Mesh.CreateBox("box", 6.0, scene);
              box.position.y = 5;

              var sphere = BABYLON.Mesh.CreateSphere("sphere1", 16, 2, scene);
              sphere.position.y = 15;
              sphere.position.z = 10;

              // Shadows
              var shadowGenerator = new BABYLON.ShadowGenerator(1024, light);
              shadowGenerator.getShadowMap().renderList.push(sphere);
              shadowGenerator.getShadowMap().renderList.push(box);
              
              shadowGenerator.useVarianceShadowMap = true;
/*
              var shadowGenerator2 = new BABYLON.ShadowGenerator(1024, light2);
              shadowGenerator2.getShadowMap().renderList.push(torus);
              shadowGenerator2.usePoissonSampling = true;
  
  */
              var subdivisions = 300;
              var width = 300;
              var height = 300;
            
              var options = {width: width, height: height, subdivisions: subdivisions, minHeight: 0,  maxHeight: 60};//, onReady: setQuads};
                
              // Ground
              var ground = BABYLON.MeshBuilder.CreateGroundFromHeightMap("ground", "textures/heightMap.png", options, scene);
              
              ground.position.y = -2.05;
              ground.material = terrainMaterial;
            
            	ground.receiveShadows = true;
              
              /*
              scene.executeWhenready( function() {  
                  var rayPick = new BABYLON.Ray(sphere.position, new BABYLON.Vector3(0, -1, 0));
                  var meshFound = scene.pickWithRay(rayPick, function (item) {
                    if (item.name.indexOf("ground") == 0)
                        return true;
                    else
                        return false;
                  });
                }
              );
*/

      scene.executeWhenReady(function () {
                  var rayPick = new BABYLON.Ray(sphere.position, new BABYLON.Vector3(0, -1, 0));
                  var meshFound = scene.pickWithRay(rayPick, function (item) {
                    if (item.name.indexOf("ground") == 0)
                        return true;
                    else
                        return false;
                  });
      });
            
          //    var pickInfo = ground.pick(sphere.position.x, sphere.position.z);
          //    sphere.position.y = pickInfo.pickedPoint.y;
              
             
              
	var waterMesh = BABYLON.Mesh.CreateGround("waterMesh", 512, 512, 32, scene, false);
	var water = new BABYLON.WaterMaterial("water", scene, new BABYLON.Vector2(512, 512));
	water.backFaceCulling = true;
	water.bumpTexture = new BABYLON.Texture("textures/waterbump.png", scene);
	water.windForce = -5;
	water.waveHeight = 0.2;
	water.bumpHeight = 0.05;
	water.waterColor = new BABYLON.Color3(0.047, 0.23, 0.015);
	water.colorBlendFactor = 0.5;
	water.addToRenderList(ground);
	waterMesh.material = water;
              
              
              
              return scene;
            }

            // call the createScene function
            var scene = createScene();

            // run the render loop
            engine.runRenderLoop(function(){
                scene.render();
            });

            // the canvas/window resize event handler
            window.addEventListener('resize', function(){
                engine.resize();
            });
        });
    </script>
  </head>
  <body>
    <canvas id="renderCanvas" style="width: 100%"></canvas>

    <!--
    <strong>Server Stats</strong><br>
    RSS: <div id='rss'></div><br>
    Heap total: <div id='heapTotal'></div><br>
    Heap used: <div id='heapUsed'></div><br>
    -->
  </body>
</html>
